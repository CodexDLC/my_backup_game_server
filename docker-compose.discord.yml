# docker-compose.discord.yml
# ===================================================================
# volumes & networks: –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏—Ö –Ω–∞ –≤–µ—Ä—Ö–Ω–µ–º —É—Ä–æ–≤–Ω–µ
# ===================================================================
volumes:
  redis_bot_local_data:
    driver: local

networks:
  backend_network:
    external:
      name: backend_network # üî• –ò–ó–ú–ï–ù–ï–ù–ò–ï: –£–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ—á–Ω–æ–µ –∏–º—è —Å–µ—Ç–∏, —Å–æ–∑–¥–∞–Ω–Ω–æ–π –±—ç–∫–µ–Ω–¥–æ–º

# ===================================================================
# x-templates: –ò—Å–ø–æ–ª—å–∑—É–µ–º —è–∫–æ—Ä—è –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –æ–±—â–∏—Ö –±–ª–æ–∫–æ–≤
# ===================================================================
x-common-env: &common-env
  env_file: .env

x-common-restart-policy: &common-restart-policy
  restart: always

x-common-build-python: &common-build-python
  build:
    context: .
    # Dockerfile –±—É–¥–µ—Ç —É–∫–∞–∑–∞–Ω –≤ –∫–∞–∂–¥–æ–º —Å–µ—Ä–≤–∏—Å–µ –æ—Ç–¥–µ–ª—å–Ω–æ

# ===================================================================
# ü§ñ –°–ï–†–í–ò–°–´ –ë–û–¢–ê
# ===================================================================
services:
  redis_bot_local: # –õ–æ–∫–∞–ª—å–Ω—ã–π Redis –¥–ª—è –±–æ—Ç–∞
    image: redis:7.2-alpine
    container_name: redis_bot_local_cache
    hostname: redis_bot_local
    <<: [*common-env, *common-restart-policy] # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ REDIS_BOT_LOCAL_PASSWORD –±–µ—Ä–µ—Ç—Å—è –∏–∑ common-env
    networks: [backend_network]
    # üî• –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º --requirepass, –∏—Å–ø–æ–ª—å–∑—É—è REDIS_BOT_LOCAL_PASSWORD
    command: redis-server --requirepass "${REDIS_BOT_LOCAL_PASSWORD}" --appendonly yes 
    volumes:
      - redis_bot_local_data:/data
    ports: # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ—Ç –ø–æ—Ä—Ç –ø—Ä–æ–±—Ä–æ—à–µ–Ω, –∫–∞–∫ –º—ã –æ–±—Å—É–∂–¥–∞–ª–∏
      - "6380:6379" # –•–æ—Å—Ç-–ø–æ—Ä—Ç:–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä-–ø–æ—Ä—Ç
    healthcheck:
      # üî• –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º -a "$${REDIS_BOT_LOCAL_PASSWORD}" –¥–ª—è healthcheck
      test: ["CMD", "redis-cli", "-a", "$${REDIS_BOT_LOCAL_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  discord_bot:
    <<: [*common-env, *common-restart-policy, *common-build-python]
    networks: [backend_network]
    build:
      dockerfile: services_config/Discord_API/Dockerfile
    container_name: discord_bot_service
    command: python -u -m game_server.app_discord_bot.main # –î–æ–±–∞–≤–ª—è–µ–º -u –¥–ª—è –Ω–µ–±—É—Ñ–µ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞
    environment:
      - DISCORD_TOKEN=${DISCORD_TOKEN}
      - REDIS_LOCAL_URL=redis://redis_bot_local:6379/0
      - GAME_SERVER_API=http://fast_api:8000 # –•–æ—Å—Ç fast_api –∏–∑ backend_network
      - CONTAINER_ID=discord_bot_service
      - GATEWAY_BOT_SECRET=${GATEWAY_BOT_SECRET}
    depends_on:
      redis_bot_local: { condition: service_healthy }
    volumes:
      - ./logs/discord_bot_output:/app/game_server/logs # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Dockerfile –±–æ—Ç–∞ –∫–æ–ø–∏—Ä—É–µ—Ç game_server/logs –∏–ª–∏ —Å–æ–∑–¥–∞—ë—Ç –ø–∞–ø–∫—É