# game_server/Logic/InfrastructureLogic/app_post

Эта папка содержит всю логику, связанную с **персистентным хранением данных в PostgreSQL** для серверной части игры. Модуль `app_post` служит централизованным узлом для взаимодействия с основной базой данных, обеспечивая структурированный и безопасный доступ к игровым данным.

## Архитектура и Принципы

Архитектура доступа к данным PostgreSQL строго следует принципам **чистой архитектуры**, **разделения ответственности по доменам** и **внедрения зависимостей**:

1. **ORM-модели (`game_server/database/models/models.py`):**
    * Определяют структуру таблиц базы данных и отношения между ними. Являются "точкой истины" для схемы данных.

2. **Централизованное Управление Сессиями (`db_instance.py` и `session_managers/`):**
    * `db_instance.py` содержит фабрику асинхронных сессий SQLAlchemy (`async_session_factory`), которая является основной точкой для получения сессий БД.
    * `session_managers/` может содержать утилиты для управления жизненным циклом сессий, если это требуется для worker'ов или специфичных операций.

3. **Доменно-ориентированные Репозитории (`repository_groups/`):**
    * Основной компонент `app_post`. Репозитории теперь организованы по **доменным папкам** (например, `accounts/`, `character/`, `game_shards/`, `meta_data_0lvl/`, `meta_data_1lvl/` и т.д.), что обеспечивает высокую модульность и легкую расширяемость.
    * **Интерфейсы (`interfaces_*.py`)**: Каждая доменная папка содержит файл `interfaces_имя_группы.py`, который определяет **абстрактные базовые классы (ABC)** для репозиториев этого домена. Эти интерфейсы задают контракт (методы, их сигнатуры), который должен быть реализован.
    * **Реализации (`*_impl.py`)**: В каждой доменной папке находятся файлы `*_impl.py`, которые содержат конкретные реализации репозиториев. Эти классы наследуют от соответствующих `ABC` интерфейсов и инкапсулируют логику взаимодействия с SQLAlchemy ORM для операций CRUD (Create, Read, Update, Delete) с конкретными моделями данных. Они принимают фабрику сессий БД через свой конструктор (`__init__`).

4. **Централизованный Менеджер Репозиториев (`repository_manager.py`):**
    * Файл `repository_manager.py` (расположенный в `game_server/Logic/InfrastructureLogic/app_post/`) агрегирует все доменно-ориентированные репозитории.
    * Он предоставляет единую точку входа для доступа ко всем репозиториям через свойства (например, `repo_manager.characters.get_by_id(...)`).
    * Этот менеджер принимает фабрику сессий SQLAlchemy в своём конструкторе и использует её для создания экземпляров всех репозиториев, передавая им фабрику сессий.

5. **Настройки SQL (`sql_config/sqlalchemy_settings.py`):**
    * Содержит настройки подключения к базе данных SQLAlchemy.

6. **Инициализация (`app_post_initializer.py`):**
   * Отвечает за инициализацию всех компонентов `app_post`, включая `repository_manager`, при старте приложения.

## Содержимое Папки

* **`repository_groups/`**: Основная папка, содержащая все доменно-ориентированные репозитории.
  * `accounts/`: Репозитории для управления учетными записями игроков.
    * `active_game_data/`: Репозитории для активных игровых данных (например, инстансы предметов).
    * `character/`: Репозитории для данных персонажей (навыки, статистика).
    * `discord/`: Репозитории для данных, связанных с Discord (сущности, роли).
    * `game_shards/`: Репозитории для управления игровыми шардами.
    * `meta_data_0lvl/`: Репозитории для низкоуровневых справочных данных (способности, материалы, навыки).
    * `meta_data_1lvl/`: Репозитории для высокоуровневых справочных данных (пулы персонажей, шаблоны экипировки).
    * `npc/`: Репозитории для данных NPC (например, монстров).
    * `system/`: Репозитории для системных данных (например, версии данных).
    * `world_state/`: Репозитории для данных состояния мира, разделенные на `auto_session/` и `core_world/`.
* **`repository_manager.py`**: Централизованный фасад для доступа ко всем репозиториям.
* **`session_managers/`**: Утилиты для управления сессиями БД, если необходимы специфические сценарии (например, для worker'ов).
* **`sql_config/`**: Конфигурационные файлы для SQLAlchemy.
* **`app_post_initializer.py`**: Модуль для инициализации и управления жизненным циклом компонентов `app_post`.
* **`managers_config.py`**: (Если этот файл используется, добавьте его описание здесь).
