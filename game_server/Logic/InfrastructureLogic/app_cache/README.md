# game_server/Logic/InfrastructureLogic/app_cache

Эта папка содержит всю логику, связанную с **кэшированием данных в Redis** для серверной части игры. Модуль `app_cache` служит централизованным узлом для взаимодействия с высокопроизводительным хранилищем данных Redis, обеспечивая быстрый доступ к часто используемым данным и статусам задач.

## Архитектура и Принципы

Архитектура кэширования строго следует принципам **инкапсуляции**, **разделения ответственности по доменам** и **централизованного управления ресурсами**:

1. **Централизованный Redis-клиент (`central_redis_client.py`):**
    * Является низкоуровневым интерфейсом к Redis, оборачивающим `redis.asyncio`.
    * Создается как единственный экземпляр (`CentralRedisClient`) при загрузке приложения и передается другим менеджерам.
    * Предоставляет обертку для большинства стандартных команд Redis (HSET, HGETALL, GET, SET и т.д.), включая поддержку JSON-сериализации/десериализации и работу с байтами для MsgPack.
    * Управляет собственным пулом подключений и обеспечивает корректную работу в асинхронной среде.

2. **Специализированные Менеджеры Кэша (`services/`):**
    * Теперь организованы по **доменным папкам** внутри `services/` (например, `character/`, `item/`, `reference_data/` и т.д.), что обеспечивает лучшую модульность и расширяемость.
    * Каждый менеджер отвечает за свой домен данных (например, персонажи, предметы, задачи, справочные данные, тики).
    * Все низкоуровневые операции с Redis инкапсулированы внутри этих менеджеров или делегированы `RedisBatchStore`.
    * Менеджеры **принимают экземпляр `CentralRedisClient` в своих конструкторах (`__init__`)** (инъекция зависимостей), что обеспечивает гибкость и облегчает тестирование.
    * Каждый менеджер также реализует соответствующий **абстрактный интерфейс (`ABC`)**, определенный в папке `app_cache/interfaces/`, что гарантирует соблюдение контрактов и улучшает имитацию (mocking) для тестирования.

3. **Вспомогательные Утилиты (`app_cache/services/task_queue/redis_batch_store.py`):**
    * `RedisBatchStore` - это специализированный менеджер, отвечающий за низкоуровневые операции сохранения и загрузки батчей в Redis HASHes, включая сериализацию MsgPack. Он теперь находится в домене `task_queue`, поскольку тесно связан с управлением задачами.

4. **Централизованная Инициализация (`app_cache_initializer.py`):**
    * Отвечает за инициализацию `CentralRedisClient` и всех специализированных менеджеров кэша при старте приложения.
    * Предоставляет функции для получения доступа к инициализированным менеджерам и корректного закрытия соединений Redis при завершении работы приложения.

5. **Организация Данных:**
    * Ключи в Redis строго типизированы и используют префиксы (например, `KEY_PREFIX_CHARACTER_SNAPSHOT`, `GENERATOR_DATA_PREFIX` и т.д.) для логической группировки данных, определенные в `game_server/config/constants/redis.py`.
    * Активно используются JSON-сериализация для хранения сложных объектов (например, слепков персонажей, данных предметов) и хэши для справочных данных.

6. **Управление Временем Жизни (TTL):**
    * Для всех кэшируемых данных устанавливается соответствующее время жизни (Time To Live - TTL) для управления свежестью данных и автоматического удаления устаревшей информации. Значения TTL определены в `game_server/config/settings/redis_setting.py`.

## Содержимое Папки

* **`central_redis_client.py`**: Определяет класс `CentralRedisClient` — низкоуровневую обертку вокруг `redis.asyncio`.
* **`app_cache_initializer.py`**: Модуль для инициализации и управления жизненным циклом всех менеджеров кэша.
* **`interfaces/`**: Подпапка, содержащая абстрактные базовые классы (интерфейсы) для каждого кэш-менеджера.
* **`services/`**: Подпапка, содержащая доменно-ориентированные подпапки со специализированными менеджерами кэша:
* **`character/`**: Менеджеры для кэширования данных персонажей.
* **`item/`**: Менеджеры для кэширования данных экземпляров предметов.
* **`reference_data/`**: Менеджеры для работы со справочными данными.
* **`shard_count/`**: Менеджеры для счетчиков игроков на шардах.
* **`task_queue/`**: Менеджеры для кэширования и управления данными задач и батчей (включая `redis_batch_store.py`).
* **`tick/`**: Менеджеры для кэширования данных тиковой системы.
