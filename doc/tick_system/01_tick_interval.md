markdown
# Game Server: Tick Processing & Auto Session API

## Обзор

Этот проект представляет серверную логику для управления авто-сессиями и обработкой тиков персонажей в игровой среде. Система предназначена для периодической обработки событий (тиков) персонажей с использованием базы данных и очередей Redis.

### Основные компоненты:

- **Авто-сессии и авто-тик:**  
  Система инициирует авто-сессию для персонажа, если та не активна. В процессе запуска выполняется проверка наличия персонажа, его сессии и создание новой записи в базе с выставлением временных маркеров (например, `last_tick_at` и `next_tick_at` с интервалом в 6 минут).

- **Очереди Redis для обработки тиков:**  
  Персонажи распределяются по категориям (exploration, crafting, trade, general) и помещаются в соответствующие очереди Redis. Функция `process_redis_queue(db: AsyncSession)` постоянно обходит эти очереди, забирая пакеты персонажей (с фиксированным размером пакета) и передавая их на обработку.

- **Обработчики тиков:**  
  Логика обработки тиков разделена по категориям и реализована в файле `game_server/Logic/DomainLogic/TickLogic/tick_handler.py`. Каждый обработчик (например, `handle_exploration_tick`, `handle_crafting_tick`, `handle_trade_tick`, `handle_general_tick`) на данном этапе содержит заглушку, которая логгирует выполнение и возвращает сообщение о завершении обработки.

- **Передача доступа к базе данных:**  
  Весь процесс работы реализован с использованием асинхронных сессий SQLAlchemy. Экземпляр `db` (тип `AsyncSession`) создаётся один раз в `auto_tick` и передаётся через цепочку (включая `process_redis_queue` и обработчики), что обеспечивает централизованное управление транзакциями и доступом к базе.

- **API для управления авто-сессиями:**  
  Используется FastAPI для предоставления REST-эндпоинтов:
  - **POST `/system/tick/auto-session/start`**: Запускает авто-сессию для персонажа. Принимает входные данные с валидацией категорий (через Pydantic-модель и Enum).
  - **DELETE `/system/tick/auto-session/delete`**: Удаляет активную авто-сессию персонажа.
  - **GET `/system/tick/auto-session/status`**: Запрашивает статус авто-сессии.

- **Docker & Docker Compose:**  
  Проект контейнеризирован. Для сборки образа без использования кэша можно использовать:
  ```bash
  docker-compose build --no-cache
Это гарантирует, что все слои будут пересобраны с нуля.


Авто-сессия
При старте авто-сессии проверяется наличие персонажа и активной сессии. Если сессия отсутствует, создаётся новая с установленными временными метками:

next_tick_at — следующий тик через 6 минут.

last_tick_at — время последнего тика.

Обработка очередей тиков
Функция process_redis_queue(db: AsyncSession) циклически перебирает очереди по категориям. Для каждого пакета персонажей вызывается функция process_category_tick(category, characters, db), которая, используя конструкцию match-case, направляет обработку в соответствующий обработчик из tick_handler.py.

Обработчики тиков
Файл tick_handler.py содержит заглушки для тестирования:

handle_exploration_tick

handle_crafting_tick

handle_trade_tick

handle_general_tick

Каждый из них логгирует завершение обработки и возвращает сообщение, что позволяет проверить корректность цепочки вызовов до реализации полной бизнес-логики.

Запрос API
Пример запроса для старта авто-сессии:

json
{
  "player_id": 123,
  "active_category": "exploration"
}
Валидация осуществляется через Pydantic модель TickRequest, где active_category ограничено типом Enum (exploration, crafting, trade, general).

Сборка Docker
Для сборки образа без использования кэшированных слоёв выполните:

bash
docker-compose build --no-cache
После чего можно запустить контейнеры:


Этот проект демонстрирует подход к асинхронной обработке игровых событий, используя современные инструменты:

FastAPI для REST API,

SQLAlchemy для работы с базой данных,

Redis для реализации очередей,

Docker для контейнеризации проекта.

Система построена так, чтобы обеспечить масштабируемость и централизованное управление транзакциями, передавая единый экземпляр базы данных через всю цепочку обработки от старта авто-сессии до выполнения тиков.