# Система Управления Discord-Ролями для Игрового Сервера

## Обзор Проекта

Этот проект представляет собой серверное приложение на **FastAPI** для управления и синхронизации ролей Discord на основе данных, поступающих с игрового сервера. Он использует **PostgreSQL** в качестве базы данных с **SQLAlchemy 2.0+** для асинхронной работы и обеспечивает надежное взаимодействие через RESTful API.

### Основные Задачи

* **Хранение привязок:** Сопоставление сущностей игрового сервера (`world_id`, `access_code`) с ролями Discord (`guild_id`, `role_id`, `role_name`, `permissions`).
* **Гибкое управление:** Предоставление API для создания, чтения, обновления и удаления (CRUD) записей ролей.
* **Массовые операции:** Поддержка массового добавления/обновления (UPSERT) и массового удаления записей.
* **Интеграция с Discord:** Возможность для Discord-бота взаимодействовать с этим API для синхронизации ролей на серверах.

---

## Архитектура Проекта

Проект имеет слоистую архитектуру для четкого разделения ответственности и обеспечения гибкости:

1.  **Слой Доступа к Данным (`DataAccessLogic`):**
    * **База данных:** PostgreSQL.
    * **ORM:** SQLAlchemy 2.0+ (async).
    * **Управление сессиями:** Отвечает за подключение к БД и управление асинхронными сессиями (`db_instance.py`).

2.  **Слой CRUD-Операций (`CRUD_LOGIC`):**
    * **Низкоуровневый CRUD (`CRUD_LOGIC/CRUD/`):** Содержит файлы (например, `crud_discord.py`) с **прямыми SQL-запросами** к соответствующим таблицам. Используется для выполнения быстрых, специфических или оптимизированных операций, минуя ORM-слой.
    * **ORM-Менеджеры (`CRUD_LOGIC/manager/`):** Содержит классы-менеджеры (например, `StateEntitiesDiscordManager` в `ORM_discord.py`), которые работают с **автоматически сгенерированными ORM-моделями SQLAlchemy**. Предоставляют высокоуровневый, объектно-ориентированный доступ к данным.
    * **Модели ORM:** Определения моделей (например, `StateEntitiesDiscord`) хранятся в соответствующих файлах менеджеров (`ORM_*.py`) и используются для взаимодействия через SQLAlchemy ORM.

3.  **Слой Бизнес-Логики (`DomainLogic`):**
    * Содержит основную игровую логику, управление персонажами, генерацию предметов, системные обработчики тиков и другие ключевые аспекты игрового сервера.

4.  **Слой Интерфейсов (`InterfacesLogic`):**
    * **Назначение:** Является "мостиком" между API-эндпоинтами и слоями данных/бизнес-логики. Здесь принимается решение, какой из слоёв доступа к данным (низкоуровневый CRUD или ORM-менеджер) использовать для конкретной операции.
    * **Пример:** `Discord_State_Entities_logic.py` координирует операции, связанные с Discord-ролями.

5.  **Слой Инфраструктуры (`InfrastructureLogic`):**
    * Включает системные компоненты, такие как инфраструктура для обработки игровых "тиков", менеджеры сокетов и слушатели событий.

6.  **Слой API (`API Layer`):**
    * **Фреймворк:** FastAPI.
    * **Роуты:** `discord_routes` (находится в `game_server/routers/discord_routes.py` или подобное).
    * **Назначение:** Предоставляет RESTful API-эндпоинты для внешнего взаимодействия (Discord-бот, другие сервисы).

---

## База данных: `state_entities_discord` (и `discord_bindings`)

Эта таблица (или таблицы) хранит сопоставления между игровыми сущностями и Discord-ролями:

* **`guild_id` (INT):** ID Discord-сервера (гильдии).
* **`world_id` (UUID):** Уникальный идентификатор сущности/мира с игрового сервера.
* **`access_code` (INT):** Код доступа или уровень, ассоциированный с игровой сущностью.
* **`role_name` (VARCHAR):** Имя роли в Discord.
* **`role_id` (BIGINT, NULLABLE):** ID роли в Discord. Может быть `NULL` до фактического создания роли в Discord.
* **`permissions` (JSONB):** JSON-поле для хранения пермиссий роли.
* **`created_at` (TIMESTAMP):** Время создания записи.
* **`updated_at` (TIMESTAMP):** Время последнего обновления записи.

**Составной первичный ключ для `state_entities_discord`:** `(guild_id, world_id, access_code)`. Это гарантирует уникальность каждой привязки игровой сущности к роли в конкретной гильдии.

*(Примечание: `discord_bindings` — это другая таблица, для которой также существуют низкоуровневые CRUD-операции. Ее предназначение может быть связано с более общими привязками в Discord, такими как каналы или категории, а не только с ролями, связанными с игровыми сущностями.)*

---

## API Эндпоинты

**Базовый URL:** `ВАШ_API_URL/discord`

### Роли и Привязки (CRUD)

* **`POST /discord/create_roles/`**
    * **Summary:** Массовое добавление/обновление записей Discord-ролей (UPSERT).
    * **Description:** Используется для синхронизации или создания нескольких записей ролей. При конфликте по первичному ключу (`guild_id`, `world_id`, `access_code`) существующая запись обновляется.
    * **Request Body:** `List[RoleBindingData]` (JSON массив объектов).
        * `guild_id` (int), `world_id` (str, UUID), `access_code` (int), `role_name` (str), `role_id` (int, optional), `permissions` (dict, optional).
    * **Возвращает:** `{"message": "..."}` или `HTTPException` в случае ошибки.

* **`POST /discord/create_bindings/`**
    * **Summary:** Массовое добавление/обновление привязок ролей.
    * **Description:** Аналогичен `create_roles/`, может использоваться для более явного обозначения синхронизации привязок.
    * **Request Body:** `List[RoleBindingData]` (тот же формат).
    * **Возвращает:** `{"message": "..."}` или `HTTPException`.

* **`GET /discord/entities/{guild_id}`**
    * **Summary:** Получить все записи ролей для гильдии.
    * **Description:** Возвращает список всех привязанных ролей для указанного `guild_id`.
    * **Parameters:** `guild_id` (path, int).
    * **Возвращает:** `List[Dict]` данных ролей или `HTTPException`.

* **`GET /discord/entity_by_pk/{guild_id}/{world_id}/{access_code}`**
    * **Summary:** Получить одну запись по полному первичному ключу.
    * **Description:** Возвращает детальную информацию об одной конкретной записи роли.
    * **Parameters:** `guild_id` (path, int), `world_id` (path, str), `access_code` (path, int).
    * **Возвращает:** `Dict` данных роли или `HTTPException (404 Not Found)`.

* **`PUT /discord/update_by_pk/{guild_id}/{world_id}/{access_code}`**
    * **Summary:** Обновить запись по полному первичному ключу.
    * **Description:** Обновляет существующую запись роли. Можно передавать только те поля, которые нужно изменить.
    * **Parameters:** `guild_id` (path, int), `world_id` (path, str), `access_code` (path, int).
    * **Request Body:** `EntityUpdateData` (JSON объект).
        * `role_name` (str, optional), `role_id` (int, optional), `permissions` (dict, optional).
    * **Возвращает:** `{"message": "..."}` или `HTTPException`.

* **`DELETE /discord/delete_by_pk/{guild_id}/{world_id}/{access_code}`**
    * **Summary:** Удалить запись по полному первичному ключу.
    * **Description:** Удаляет одну конкретную запись роли из базы данных.
    * **Parameters:** `guild_id` (path, int), `world_id` (path, str), `access_code` (path, int).
    * **Возвращает:** `{"message": "..."}` или `HTTPException (404 Not Found)`.

---

## Настройка и Запуск

### Зависимости

Убедитесь, что установлены все необходимые зависимости (например, из `requirements.txt`):

```bash
pip install fastapi uvicorn sqlalchemy asyncpg pydantic aiohttp