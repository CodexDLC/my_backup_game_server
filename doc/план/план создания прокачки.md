# План разработки тик-системы и прокачки навыков

Ниже перечислены все этапы в виде отдельных Markdown-файлов. Сохраните каждый раздел как отдельный файл в корне документации проекта.

---

## 01\_tick\_interval.md

```markdown
# 1. Интервал тика

**Цель:** определить, как и когда запускается процесс начисления XP (тик-система) в авто-режиме.

1. **Механизм запуска:** глобальный воркер (cron/Celery Beat) с интервалом 1 минута.
2. **Отбор сессий:** выбираем `auto_sessions`, у которых `next_tick_at <= now()`.
3. **Обновление расписания:** после обработки смещаем `next_tick_at` на 10 минут.
4. **Шардирование и батчи:** при >50k сессий разбиваем по `character_id % N`.
5. **Мониторинг:** метрики времени выполнения и числа обработанных сессий.
```

---

## 02\_active\_skills\_filter.md

````markdown
# 2. Фильтрация активных навыков

**Цель:** на каждом тике выбирать только навыки со `progress_state` = `MINUS` или `PLUS` и обеспечивать порядок: сначала `MINUS`, затем `PLUS`.

1. **SQL-запрос:**
   ```sql
   SELECT skill_id, level, xp, progress_state
   FROM character_skills
   WHERE character_id = :id
     AND progress_state <> 'PAUSE'
   ORDER BY CASE WHEN progress_state='MINUS' THEN 0 ELSE 1 END;
````

2. **Индекс:** `CREATE INDEX ON character_skills(character_id, progress_state)`.
3. **Порядок обработки:**

   * Сначала деградация (`MINUS`), затем начисление (`PLUS`).
4. **Тесты:** проверка выборки и сортировки.

````

---

## 03_xp_calculation_plan.md
```markdown
# 3. Расчёт ΔXP и применение порогов

**Цель:** для каждого активного навыка использовать `base_xp` (2×main + 1×secondary) и применить:
- `PLUS`: `xp += base_xp`
- `MINUS`: `xp -= floor(base_xp/2)`

1. **Таблица skill_base_xp** хранит `base_xp` на персонажа и навык.
2. **Порог:** проверять только порог для `level+1` из `skill_unlocks`.
3. **Carry-over:** остаток XP сохраняется.
4. **Логика:** обновление XP, запись в `progression_ticks`, проверка и повышение уровня.
5. **Тесты:** граничные SPECIAL, точность порога.
````

---

## 04\_ability\_unlock\_plan.md

```markdown
# 4. Открытие способностей

**Цель:** после повышения уровня навыка разблокировать новые способности.

1. При `level` → сделать один запрос к `skill_ability_unlocks`.
2. Вставить в `character_abilities`, избегая дубликатов.
3. Логирование разблокировки: персонаж, навык, уровень, способность.
4. Тесты: отсутствие дубликатов, корректность вставок.
```

---

## 05\_monitoring\_and\_logger\_plan.md

```markdown
# 5. Мониторинг и логирование

**Цель:** отслеживать работу тик-системы и ключевые метрики.

1. **Журналы:** `progression_ticks`, `ability_unlocks_log`, `tick_execution_log`.
2. **Логи:** JSON-формат, теги `character_id`, `tick_id`.
3. **Метрики Prometheus:** время тика, число сессий, ошибки.
4. **Алерты:** превышение порогов длительности.
```

---

## 06\_infrastructure\_and\_scaling\_plan.md

```markdown
# 6. Инфраструктура и масштабирование

**Цель:** обеспечить надёжную работу при росте нагрузки.

1. **Шардирование:** `character_id % N` на N воркеров.
2. **Пул соединений и батчи:** операции в одной транзакции.
3. **Кэш/Redis:** хранение `auto_sessions` или пулов.
4. **Автоскейлинг:** метрики + Kubernetes.
```

---

## 07\_auto\_session\_management\_plan.md

```markdown
# 7. Управление авто-сессиями

**Цель:** описать вход/выход в авто-режим и блокировку.

1. **Сессии:** время старта, `last_tick_at`, `next_tick_at`, `active_category`.
2. **API:** endpoints для старта и остановки сессии.
3. **Планирование:** выборка готовых сессий, обновление расписаний.
4. **Блокировка:** пометка «в процессе» при обработке.
5. **Тесты:** создание, удаление, корректное смещение `next_tick_at`.
```

---

*Сохраните каждый раздел как отдельный Markdown-файл.*
